<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ± ç”°å¸‚ã‚¸ãƒ¥ãƒ‹ã‚¢å“çƒ ãƒãƒ¼ãƒ åˆ†ã‘ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 0; }
        
        /* ãƒ­ãƒƒã‚¯ç”»é¢ */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; color: #333; width: 300px; }
        #pass-input { padding: 10px; font-size: 16px; width: 80%; margin-bottom: 15px; text-align: center; letter-spacing: 2px; }

        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ */
        #main-app { display: none; padding: 20px; }
        .container { max-width: 1250px; margin: 0 auto; background: #fff; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 8px; }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        p.status-bar { text-align: center; font-size: 0.9em; height: 20px; margin-bottom: 15px; font-weight: bold; }
        .status-loading { color: #e67e22; }
        .status-success { color: #27ae60; }
        .status-error { color: #c0392b; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-wrapper { max-height: 450px; overflow-y: auto; border: 1px solid #ddd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 6px; border-bottom: 1px solid #ddd; text-align: center; font-size: 14px; vertical-align: middle; }
        th { background-color: #0056b3; color: white; position: sticky; top: 0; z-index: 10; }
        tr:hover { background-color: #f9f9f9; }
        
        input[type="text"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 14px; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; width: 100%; cursor: pointer; box-sizing: border-box; }
        .select-M { color: blue; font-weight: bold; }
        .select-F { color: #d63384; font-weight: bold; }

        /* ãƒœã‚¿ãƒ³é¡ */
        .controls { text-align: center; margin: 20px 0; background: #eee; padding: 15px; border-radius: 8px; display: flex; justify-content: center; align-items: center; gap: 20px; }
        button { border: none; padding: 12px 25px; font-size: 16px; cursor: pointer; border-radius: 5px; transition: background 0.3s; font-weight: bold; color: white; }
        .btn-exec { background-color: #28a745; }
        .btn-shuffle { background-color: #e67e22; }
        
        /* è¿½åŠ ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .btn-add { background-color: #0984e3; font-size: 14px; padding: 8px 15px; margin-bottom: 10px; }
        .btn-add:hover { background-color: #74b9ff; }
        .btn-delete { background-color: #e74c3c; padding: 5px 10px; font-size: 12px; border-radius: 3px; }
        .btn-delete:hover { background-color: #c0392b; }

        .radio-group { font-weight: bold; color: #555; background: #fff; padding: 8px 15px; border-radius: 20px; border: 1px solid #ccc; }

        /* çµæœã‚¨ãƒªã‚¢ */
        #result-area { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px; }
        .team-card { background: #fff; border: 2px solid #e9ecef; border-radius: 8px; width: 240px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .team-title { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; text-align: center; color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 5px;}
        .team-stats { font-size: 0.8em; color: #555; text-align: center; margin-bottom: 8px; background: #f8f9fa; padding: 5px; border-radius: 4px; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px dotted #ccc; font-size: 0.9em; }
        .rank-badge { display: inline-block; padding: 2px 4px; border-radius: 3px; font-size: 0.7em; color: white; min-width: 25px; text-align: center; margin-left: 5px;}
        .rank-1 { background-color: #d63031; } 
        .rank-2 { background-color: #e17055; } 
        .rank-3 { background-color: #fdcb6e; color: #333; } 
        .rank-4 { background-color: #0984e3; } 
        .rank-5 { background-color: #00b894; } 
    </style>
</head>
<body>

<div id="login-overlay">
    <div id="login-box">
        <h3>ğŸ“ é–¢ä¿‚è€…èªè¨¼</h3>
        <p>åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="password" id="pass-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <br>
        <button onclick="checkPass()" style="background:#0056b3; margin-top:10px;">å…¥å®¤</button>
        <p id="login-msg" style="color:red; font-size:0.8em; min-height:1.2em;"></p>
    </div>
</div>

<div id="main-app">
    <div class="container">
        <h1>ğŸ“ ãƒãƒ¼ãƒ åˆ†ã‘ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p id="status-msg" class="status-bar">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <button class="btn-add" onclick="addMember()">ï¼‹ æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
            <div style="font-weight:bold; font-size:0.9em;">
                ç¾åœ¨é¸æŠä¸­: <span id="selected-count">0</span> å
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width:40px;">å‚åŠ </th>
                        <th style="width:30px;">No</th>
                        <th style="min-width:120px;">æ°å</th>
                        <th style="width:60px;">æ€§åˆ¥</th>
                        <th style="width:80px;">ä¸–ä»£</th>
                        <th style="width:100px;">ç·´åº¦</th>
                        <th style="width:40px;">R</th>
                        <th style="width:50px;">å‰Šé™¤</th>
                    </tr>
                </thead>
                <tbody id="member-list"></tbody>
            </table>
        </div>

        <div class="controls">
            <div class="radio-group">
                <label style="margin-right: 15px;"><input type="radio" name="teamSize" value="4" checked> 4äººãƒãƒ¼ãƒ å„ªå…ˆ</label>
                <label><input type="radio" name="teamSize" value="3"> 3äººãƒãƒ¼ãƒ å„ªå…ˆ</label>
            </div>
            <button class="btn-exec" onclick="generateTeams()">ãƒãƒ¼ãƒ åˆ†ã‘ã‚’å®Ÿè¡Œ</button>
            <button class="btn-shuffle" onclick="generateTeams()">ğŸ”„ æ´—æ›¿</button>
        </div>

        <div id="result-area"></div>
    </div>
</div>

<script>
    // ==========================================
    // â–¼ è¨­å®šã‚¨ãƒªã‚¢ â–¼
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwsCe-MXHrW7Cjd2je5GT93i4H1hYaVGdQNzFwmSV8LEoWclFaWCVx7JABaDjAuwLZ2/exec";   // GASã®URL
    const CORRECT_PASS = "iketaku";           // åˆè¨€è‘‰
    // ==========================================

    let membersDB = [];
    const genOptions = ["ï½¼ï¾ï½­ï¾†ï½±", "ï¾”ï¾ï½¸ï¾", "ï½±ï¾€ï¾ï¾™ï¾„", "ï½¼ï¾†ï½±"];
    const levelMap = { 1: "å¸«ç¯„", 2: "ï½ºï½°ï¾", 3: "ï¾ï¾ï¾ƒï¾—ï¾", 4: "ï¾šï½·ï¾ï½­ï¾—ï½°", 5: "ï¾‹ï¾ï½·ï¾ï¾…ï½°" };
    const statusMsg = document.getElementById('status-msg');

    // â–¼ èªè¨¼ãƒ»åˆæœŸåŒ– â–¼
    window.onload = function() {
        if(localStorage.getItem("tabletennis_auth") === CORRECT_PASS) {
            showApp();
        }
    };
    function checkPass() {
        const input = document.getElementById('pass-input').value;
        if(input === CORRECT_PASS) {
            localStorage.setItem("tabletennis_auth", input);
            showApp();
        } else {
            document.getElementById('login-msg').textContent = "åˆè¨€è‘‰ãŒé•ã„ã¾ã™";
        }
    }
    function showApp() {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        loadData();
    }

    // â–¼ ãƒ‡ãƒ¼ã‚¿é€šä¿¡ â–¼
    async function loadData() {
        if(API_URL.includes("YOUR_GAS_URL")) {
            statusMsg.textContent = "URLæœªè¨­å®šã‚¨ãƒ©ãƒ¼";
            statusMsg.className = "status-bar status-error";
            return;
        }
        try {
            statusMsg.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
            statusMsg.className = "status-bar status-loading";
            const res = await fetch(API_URL);
            membersDB = await res.json();
            renderTable();
            statusMsg.textContent = "å®Œäº†";
            statusMsg.className = "status-bar status-success";
            setTimeout(() => { statusMsg.textContent = ""; }, 2000);
        } catch (e) {
            statusMsg.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼";
            statusMsg.className = "status-bar status-error";
        }
    }

    // æ–°è¦è¿½åŠ 
    async function addMember() {
        if(!confirm("æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè¿½åŠ å¾Œã€åå‰ãªã©ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ï¼‰")) return;
        
        statusMsg.textContent = "è¿½åŠ ä¸­...";
        statusMsg.className = "status-bar status-loading";
        
        try {
            await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: 'add' }) // è¿½åŠ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            });
            await loadData(); // ãƒªã‚¹ãƒˆã‚’å†èª­è¾¼
            statusMsg.textContent = "è¿½åŠ ã—ã¾ã—ãŸ";
            statusMsg.className = "status-bar status-success";
        } catch (e) {
            statusMsg.textContent = "è¿½åŠ ã‚¨ãƒ©ãƒ¼";
            statusMsg.className = "status-bar status-error";
        }
    }

    // å‰Šé™¤
    async function deleteMember(id, name) {
        if(!confirm(`ã€Œ${name}ã€ã•ã‚“ã‚’åç°¿ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;

        statusMsg.textContent = "å‰Šé™¤ä¸­...";
        statusMsg.className = "status-bar status-loading";

        try {
            await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: 'delete', id: id }) // å‰Šé™¤ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            });
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤ã—ã¦å³æ™‚åæ˜ ï¼ˆãã®å¾Œãƒ­ãƒ¼ãƒ‰ã§åŒæœŸï¼‰
            membersDB = membersDB.filter(m => m.id !== id);
            renderTable();
            await loadData(); 
            statusMsg.textContent = "å‰Šé™¤ã—ã¾ã—ãŸ";
            statusMsg.className = "status-bar status-success";
        } catch (e) {
            statusMsg.textContent = "å‰Šé™¤ã‚¨ãƒ©ãƒ¼";
            statusMsg.className = "status-bar status-error";
        }
    }

    // æ›´æ–°
    async function sendUpdate(id, field, value) {
        statusMsg.textContent = "ä¿å­˜ä¸­...";
        statusMsg.className = "status-bar status-loading";

        const member = membersDB.find(m => m.id === id);
        if (member) {
            if (field === 'name') member.name = value;
            if (field === 'gender') member.gender = value;
            if (field === 'gen') member.gen = value;
            if (field === 'level') {
                member.level = parseInt(value);
                member.type = levelMap[member.level];
            }
            if (field === 'active') member.active = value;
            if(field !== 'name') renderTable(); 
        }

        try {
            await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: 'update', id: id, field: field, value: value })
            });
            statusMsg.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
            statusMsg.className = "status-bar status-success";
            setTimeout(() => { statusMsg.textContent = ""; }, 1500);
        } catch (e) {
            statusMsg.textContent = "ä¿å­˜ã‚¨ãƒ©ãƒ¼";
            statusMsg.className = "status-bar status-error";
        }
    }

    // â–¼ æç”»ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ â–¼
    function renderTable() {
        const tableBody = document.getElementById('member-list');
        let html = '';
        
        // IDé †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
        membersDB.sort((a,b) => a.id - b.id);

        membersDB.forEach(member => {
            const checked = member.active ? 'checked' : '';
            const rankClass = `rank-${member.level}`;
            const nameInput = `<input type="text" value="${member.name}" onchange="sendUpdate(${member.id}, 'name', this.value)">`;
            
            const genderClass = member.gender === 'M' ? 'select-M' : 'select-F';
            let genderSelect = `<select class="${genderClass}" onchange="sendUpdate(${member.id}, 'gender', this.value)">`;
            genderSelect += `<option value="M" ${member.gender === 'M' ? 'selected' : ''}>ç”·</option>`;
            genderSelect += `<option value="F" ${member.gender === 'F' ? 'selected' : ''}>å¥³</option>`;
            genderSelect += `</select>`;

            let genSelect = `<select onchange="sendUpdate(${member.id}, 'gen', this.value)">`;
            genOptions.forEach(opt => {
                const selected = member.gen === opt ? 'selected' : '';
                genSelect += `<option value="${opt}" ${selected}>${opt}</option>`;
            });
            genSelect += `</select>`;

            let levelSelect = `<select onchange="sendUpdate(${member.id}, 'level', this.value)">`;
            for (let lv = 1; lv <= 5; lv++) {
                const selected = member.level === lv ? 'selected' : '';
                levelSelect += `<option value="${lv}" ${selected}>${levelMap[lv]}</option>`;
            }
            levelSelect += `</select>`;

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            const deleteBtn = `<button class="btn-delete" onclick="deleteMember(${member.id}, '${member.name}')">å‰Šé™¤</button>`;

            html += `
                <tr>
                    <td><input type="checkbox" class="attendance-check" value="${member.id}" ${checked} onchange="toggleActive(${member.id}, this.checked)"></td>
                    <td>${member.id}</td>
                    <td>${nameInput}</td>
                    <td>${genderSelect}</td>
                    <td>${genSelect}</td>
                    <td>${levelSelect}</td>
                    <td><span class="rank-badge ${rankClass}">${member.level}</span></td>
                    <td>${deleteBtn}</td>
                </tr>
            `;
        });
        tableBody.innerHTML = html;
        updateCount();
    }

    function toggleActive(id, isChecked) {
        sendUpdate(id, 'active', isChecked);
        updateCount();
    }

    function updateCount() {
        const count = membersDB.filter(m => m.active).length;
        document.getElementById('selected-count').textContent = count;
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function generateTeams() {
        let participants = membersDB.filter(m => m.active);
        if (participants.length < 3) { alert("æœ€ä½3åã®å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

        let groups = {1:[], 2:[], 3:[], 4:[], 5:[], 'other':[]};
        participants.forEach(p => {
            if (groups[p.level]) groups[p.level].push(p);
            else groups['other'].push(p);
        });

        let sortedParticipants = [];
        [1, 2, 3, 4, 5, 'other'].forEach(lvl => {
            sortedParticipants = sortedParticipants.concat(shuffleArray([...groups[lvl]]));
        });

        const preferredSize = parseInt(document.querySelector('input[name="teamSize"]:checked').value);
        let numTeams = preferredSize === 4 ? Math.ceil(sortedParticipants.length / 4) : Math.ceil(sortedParticipants.length / 3);
        if (sortedParticipants.length / numTeams < 3) numTeams = Math.floor(sortedParticipants.length / 3);
        if (numTeams < 1) numTeams = 1;

        let teams = Array.from({ length: numTeams }, () => []);
        sortedParticipants.forEach((player, index) => {
            const cycle = Math.floor(index / numTeams);
            const teamIndex = (cycle % 2 === 0) ? index % numTeams : (numTeams - 1) - (index % numTeams);
            teams[teamIndex].push(player);
        });

        const resultArea = document.getElementById('result-area');
        resultArea.style.opacity = '0.5';
        setTimeout(() => {
            resultArea.innerHTML = '';
            teams.forEach((team, i) => {
                const avgLevel = (team.reduce((sum, p) => sum + p.level, 0) / team.length).toFixed(1);
                const maleCount = team.filter(p => p.gender === 'M').length;
                const femaleCount = team.filter(p => p.gender === 'F').length;
                let membersHtml = '';
                team.forEach(p => {
                    membersHtml += `<div class="member-item">
                        <span>${p.name} <span style="font-size:0.8em">(${p.gen})</span></span>
                        <span><span class="rank-badge rank-${p.level}">${p.level}</span></span>
                    </div>`;
                });
                resultArea.innerHTML += `<div class="team-card">
                    <div class="team-title">ãƒãƒ¼ãƒ  ${String.fromCharCode(65 + i)}</div>
                    <div class="team-stats">å¹³å‡ãƒ©ãƒ³ã‚¯: <b>${avgLevel}</b> / ç”·:${maleCount} å¥³:${femaleCount}</div>
                    ${membersHtml}
                </div>`;
            });
            resultArea.style.opacity = '1';
        }, 150);
    }
</script>
</body>
</html>